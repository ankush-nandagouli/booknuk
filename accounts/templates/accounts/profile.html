{% extends 'base.html' %}
{% load static %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}
{% if not request.user.profile_completed %}
  <div class="mb-4 px-4 py-2 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded">
    ‚ö†Ô∏è Your profile is incomplete. Please update it to unlock all features.
  </div>
{% endif %}

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">

  <!-- Profile Card -->
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg glass-effect flex flex-col items-center Shery"
       data-shery="zoom">
    <!-- Profile Picture -->
    <div class="w-32 h-32 mb-4 Shery" data-shery="float">
      <img src="{% if request.user.profile_picture %}{{ request.user.profile_picture.url }}{% else %}{% static 'default_avatar.png' %}{% endif %}"
           alt="Profile Picture"
           class="rounded-full object-cover w-full h-full border-4 border-indigo-500"/>
    </div>

    <h2 class="text-xl font-bold bg-gradient-to-r from-indigo-500 to-purple-500 bg-clip-text text-transparent mb-2">
      {{ request.user.first_name|default:request.user.username }}
    </h2>
    <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">{{ request.user.email }}</p>

    <ul class="text-sm space-y-2 text-gray-800 dark:text-gray-200 text-left w-full">
      <li><strong>Branch:</strong> {{ request.user.branch|default:"N/A" }}</li>
      <li><strong>Course:</strong> {{ student.course|default:"N/A" }}</li>
      <li><strong>Roll No:</strong> {{ request.user.roll_number|default:"N/A" }}</li>
      <li><strong>Mobile:</strong> {{ request.user.mobile_number|default:"Not Provided" }}</li>
      <li><strong>Session:</strong> {{ request.user.academic_session|default:"N/A" }}</li>
      <li><strong>Year:</strong> {{ student.year_of_study|default:"N/A" }}</li>
      <li><strong>Joined:</strong> {{ request.user.date_joined|date:"d M, Y" }}</li>
    </ul>

    <div class="mt-6 w-full">
      <a href="{% url 'profile_update' %}"
         class="block py-2 px-6 bg-indigo-600 text-center text-white rounded-md hover:bg-indigo-700 focus:outline-none Shery"
         data-shery="slide">
        Update Profile
      </a>
    </div>
  </div>

  <!-- Library Card with Flip Effect -->
  <div class="md:col-span-2 flex justify-center items-center">
    <div class="flip-card w-full max-w-lg h-60 relative">
      <div class="flip-card-inner" id="flipCard">

        <!-- Front -->
        <div class="flip-card-front relative bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-xl shadow-xl Shery"
             data-shery="float">
          <!-- Chip -->
          <div class="w-12 h-6 bg-yellow-400 text-xs text-center font-bold rounded mb-4 shadow">
            SCEP
          </div>

          <!-- Info -->
          <h3 class="text-lg font-semibold mb-2">Library Card</h3>
          <p class="text-base font-mono tracking-wide mb-4">
            {{ request.user.library_card|default:"Not Issued Yet" }}
          </p>

          <div class="flex justify-between text-sm mb-4">
            <div>
              <p class="uppercase text-gray-300">Issued</p>
              <p>{{ request.user.date_joined|date:"d M, Y" }}</p>
            </div>
            <div class="text-right">
              <p class="uppercase text-gray-300">Status</p>
              <p>{{ request.user.is_approved|yesno:"‚úÖ Approved,‚è≥ Pending" }}</p>
            </div>
          </div>

          <!-- Logo -->
          <div class="absolute top-4 right-4">
            <img src="{% static 'images/SATPUDALOGO.png' %}" alt="Library Logo"
                 class="w-12 h-12 opacity-90" />
          </div>
        </div>

        <!-- Back -->
        <div class="flip-card-back bg-white dark:bg-gray-900 text-center p-6 rounded-xl shadow-xl flex flex-col items-center justify-center">
          <h3 class="text-sm font-bold text-indigo-600 mb-3">Scan QR Code</h3>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data={{ request.user.library_card }}"
               alt="QR Code"
               class="shadow rounded-lg"/>
          <p class="mt-3 text-xs text-gray-500">ID: {{ request.user.library_card }}</p>
        </div>

      </div>

      <!-- Flip Button (mobile friendly) -->
      <button id="flipBtn"
              class="absolute bottom-3 right-3 bg-indigo-600 text-white px-3 py-1 text-xs rounded-md hover:bg-indigo-700 md:hidden">
        üîÑ Flip
      </button>
    </div>
  </div>

</div>

<!-- Flip Card CSS -->
<style>
.flip-card { perspective: 1000px; }
.flip-card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  transition: transform 0.6s;
}
.flip-card.flip .flip-card-inner,
.flip-card:hover .flip-card-inner {
  transform: rotateY(180deg);
}
.flip-card-front, .flip-card-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 0.75rem;
}
.flip-card-back { transform: rotateY(180deg); }
.glass-effect {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
}
</style>

<!-- Shery.js -->
<script src="https://unpkg.com/sheryjs/dist/Shery.js"></script>
<script>
  Shery.mouseFollower();
  Shery.makeMagnet(".Shery");

  // Mobile flip button
  const flipCard = document.querySelector(".flip-card");
  const flipBtn = document.getElementById("flipBtn");
  flipBtn.addEventListener("click", () => {
    flipCard.classList.toggle("flip");
  });
</script>
{% endblock %}
